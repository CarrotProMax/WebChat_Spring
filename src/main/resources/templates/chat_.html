<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebChat</title>
    <style>
        :root {
            --primary-color: #4f46e5;
            --sidebar-width: 60px;
            --middlebar-width: 250px;
            --header-height: 60px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
            background-color: #f8f9fa;
        }

        .chat-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: #1e293b;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            transition: all 0.3s;
        }

        .sidebar-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            cursor: pointer;
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            transition: all 0.2s;
        }

        .sidebar-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .sidebar-btn.active {
            background-color: var(--primary-color);
        }

        .middlebar {
            width: var(--middlebar-width);
            background-color: white;
            border-right: 1px solid #e5e7eb;
            transition: all 0.3s;
            overflow-y: auto;
        }

        .middlebar.collapsed {
            width: 0;
            overflow: hidden;
            border-right: none;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #f3f4f6;
        }

        .chat-header {
            height: var(--header-height);
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f3f4f6;
        }

        .message-input {
            height: 80px;
            background-color: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .contact-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .contact-item:hover {
            background-color: #f3f4f6;
        }

        .contact-item.active {
            background-color: #eef2ff;
            border-left: 3px solid var(--primary-color);
        }

        .message {
            max-width: 70%;
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            position: relative;
        }

        .message.received {
            background-color: white;
            border: 1px solid #e5e7eb;
            margin-right: auto;
        }

        .message.sent {
            background-color: var(--primary-color);
            color: white;
            margin-left: auto;
        }

        .message-time {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
            text-align: right;
        }

        .message.sent .message-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .no-contacts {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280;
            padding: 20px;
            text-align: center;
        }

        .no-contacts-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #d1d5db;
        }

        .search-box {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        @media (max-width: 768px) {
            .middlebar {
                position: absolute;
                left: var(--sidebar-width);
                top: 0;
                bottom: 0;
                z-index: 100;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .middlebar.collapsed {
                transform: translateX(-100%);
            }
        }
    </style>
</head>
<body>
<div class="chat-container">
    <!-- å·¦ä¾§åŠŸèƒ½æ  -->
    <div class="sidebar">
        <button id="toggleMiddlebar" class="sidebar-btn">
            <i class="bi bi-list"></i>
        </button>
        <button id="showContacts" class="sidebar-btn active">
            <i class="bi bi-people"></i>
        </button>
    </div>

    <!-- ä¸­é—´æ  -->
    <div class="middlebar" id="middlebar">
        <div class="search-box">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="æœç´¢è”ç³»äºº...">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
        <div id="contactsList">
            <!-- è”ç³»äººåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            <div class="no-contacts">
                <div class="no-contacts-icon">
                    <i class="bi bi-people"></i>
                </div>
                <h5>æš‚æ— è”ç³»äºº</h5>
                <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ·æ–°æˆ–æ·»åŠ æ–°è”ç³»äºº</p>
            </div>
        </div>
    </div>

    <!-- å³ä¾§èŠå¤©åŒº -->
    <div class="chat-area">
        <div class="chat-header">
            <h5 id="currentContact" class="mb-0">è¯·é€‰æ‹©è”ç³»äººå¼€å§‹èŠå¤©</h5>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- èŠå¤©æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center text-muted">
                    <i class="bi bi-chat-left-text" style="font-size: 48px;"></i>
                    <h4 class="mt-3">é€‰æ‹©è”ç³»äººå¼€å§‹èŠå¤©</h4>
                </div>
            </div>
        </div>
        <div class="message-input">
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled>
                <button id="sendButton" class="btn btn-primary" type="button" disabled>
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // å…¨å±€å˜é‡
    let uid = null;
    let currentContact = null;
    let contacts = [];
    let heartbeatInterval;
    let refreshInterval;

    // ä»URLè·å–uidå‚æ•°
    function getUidFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('uid');
    }

    // åˆå§‹åŒ–é¡µé¢
    $(document).ready(function() {
        uid = getUidFromUrl();
        if (!uid) {
            alert('ç”¨æˆ·IDæœªæä¾›ï¼Œè¯·é‡æ–°ç™»å½•');
            return;
        }

        // åˆå§‹åŒ–å®šæ—¶å™¨
        startHeartbeat();
        startRefresh();

        // è·å–è”ç³»äººåˆ—è¡¨
        getContacts();

        // ç»‘å®šäº‹ä»¶
        $('#toggleMiddlebar').click(toggleMiddlebar);
        $('#showContacts').click(showContacts);
        $('#sendButton').click(sendMessage);
        $('#messageInput').keypress(function(e) {
            if (e.which === 13) {
                sendMessage();
            }
        });
    });

    // åˆ‡æ¢ä¸­é—´æ æ˜¾ç¤º/éšè—
    function toggleMiddlebar() {
        $('#middlebar').toggleClass('collapsed');
    }

    // æ˜¾ç¤ºè”ç³»äººåˆ—è¡¨
    function showContacts() {
        $('#showContacts').addClass('active');
        getContacts();
    }

    // å‘é€AJAXè¯·æ±‚
    // æ–°ç‰ˆæœ¬å‡½æ•°ï¼Œæ˜ç¡®åŒ…å«redirectHandlerå‚æ•°
    function sendAjaxRequest(data, callback, redirectHandler) {
        console.log('å‘é€è¯·æ±‚:', data);
        $.ajax({
            url: '/function',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                console.log('æ”¶åˆ°å“åº”:', response);
                // å¤„ç†é‡å®šå‘
                if (response.redirect) {
                    if (redirectHandler) {
                        redirectHandler(response.redirect);
                    } else {
                        window.location.href = response.redirect;
                    }
                    return;
                }

                if (callback) callback(response);
            },
            error: function(xhr, status, error) {
                console.error('è¯·æ±‚å¤±è´¥:', error);

                try {
                    const errorResponse = JSON.parse(xhr.responseText);
                    if (errorResponse.redirect) {
                        if (redirectHandler) {
                            redirectHandler(errorResponse.redirect);
                        } else {
                            window.location.href = errorResponse.redirect;
                        }
                        return;
                    }
                } catch (e) {
                    console.log('æ— æ³•è§£æé”™è¯¯å“åº”');
                }

                // åŸæœ‰çš„é”™è¯¯å›è°ƒå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
            }
        });
    }

    // å¿ƒè·³æ£€æµ‹
    function startHeartbeat() {
        heartbeatInterval = setInterval(function() {
            sendAjaxRequest({
                uid: uid,
                operateSymbol: 0,
                sendName: null,
                receiveName: null,
                message: null,
                time: null
            });
        }, 4000);
    }

    // åˆ·æ–°èŠå¤©
    function startRefresh() {
        refreshInterval = setInterval(function() {
            if (currentContact) {
                sendAjaxRequest({
                    uid: uid,
                    operateSymbol: 1,
                    sendName: null,
                    receiveName: currentContact,
                    message: null,
                    time: null
                }, function(response) {
                    if (response && response.length > 0) {
                        displayMessages(response);
                    }
                });
            }
        }, 2000);
    }

    // è·å–è”ç³»äººåˆ—è¡¨
    function getContacts() {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        $('#contactsList').html('<div class="text-center py-3"><i class="bi bi-arrow-repeat spin"></i> åŠ è½½ä¸­...</div>');

        sendAjaxRequest({
            uid: uid,
            operateSymbol: 4,
            sendName: null,
            receiveName: null,
            message: null,
            time: null
        }, function(response) {
            if (response && typeof response === 'object' && Object.keys(response).length > 0) {
                contacts = response;
                renderContactsList();
            } else {
                showNoContactsUI();
            }
        }, function(error) {
            // é”™è¯¯å¤„ç†
            $('#contactsList').html('<div class="alert alert-danger">åŠ è½½è”ç³»äººå¤±è´¥ï¼Œè¯·é‡è¯•</div>');
        });
    }


    /**
     * æ˜¾ç¤ºæ— è”ç³»äººæ—¶çš„UI
     */
    function showNoContactsUI() {
        $('#contactsList').html(`
        <div class="no-contacts">
            <div class="no-contacts-icon">
                <i class="bi bi-people"></i>
            </div>
            <h5>æš‚æ— è”ç³»äºº</h5>
            <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ·æ–°æˆ–æ·»åŠ æ–°è”ç³»äºº</p>
        </div>
    `);
    }

    /**
     * æ¸²æŸ“è”ç³»äººåˆ—è¡¨
     */
    function renderContactsList() {
        let html = '';

        // æ£€æŸ¥contactsæ˜¯å¦æœ‰æ•ˆ
        if (!contacts || typeof contacts !== 'object') {
            showNoContactsUI();
            return;
        }

        // è·å–æ‰€æœ‰è”ç³»äººé”®å€¼å¯¹
        const contactEntries = Object.entries(contacts);

        // å¦‚æœæ²¡æœ‰è”ç³»äººï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
        if (contactEntries.length === 0) {
            showNoContactsUI();
            return;
        }

        // éå†æ‰€æœ‰è”ç³»äºº
        contactEntries.forEach(([username, avatarPath]) => {
            // å¤„ç†å¤´åƒè·¯å¾„ - å°†æœ¬åœ°è·¯å¾„è½¬æ¢ä¸ºå¯è®¿é—®çš„URL
            // å‡è®¾åç«¯å·²ç»æä¾›äº†æ­£ç¡®çš„å¯è®¿é—®URLï¼Œå¦‚æœæ²¡æœ‰ï¼Œéœ€è¦ä¿®æ”¹ä¸ºæ­£ç¡®çš„è·¯å¾„
            // è¿™é‡Œåªæ˜¯ç¤ºä¾‹ï¼Œå®é™…åº”æ ¹æ®ä½ çš„æœåŠ¡å™¨é…ç½®è°ƒæ•´
            let avatarUrl = avatarPath;

            // å¦‚æœè·¯å¾„æ˜¯æœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼Œå°è¯•è½¬æ¢ä¸ºå¯è®¿é—®çš„URL
            if (avatarPath && avatarPath.startsWith('D:/head/')) {
                // è¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„å®é™…æœåŠ¡å™¨é…ç½®ä¿®æ”¹
                // ä¾‹å¦‚ï¼Œå¦‚æœå¤´åƒå­˜å‚¨åœ¨æœåŠ¡å™¨çš„/headç›®å½•ä¸‹
                avatarUrl = avatarPath.replace('D:/head/', '/head/');
            }

            // ç”Ÿæˆå¤´åƒHTMLï¼Œå¦‚æœæœ‰å¤´åƒåˆ™ä½¿ç”¨å¤´åƒï¼Œå¦åˆ™ä½¿ç”¨é¦–å­—æ¯
            const avatarHtml = avatarUrl
                ? `<img src="${avatarUrl}" alt="${username}" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover; margin-right: 10px;">`
                : `<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; margin-right: 10px;">
                ${getInitials(username)}
               </div>`;

            // æ„å»ºè”ç³»äººé¡¹HTML
            html += `
        <div class="contact-item ${currentContact === username ? 'active' : ''}" data-contact="${username}">
            <div class="d-flex align-items-center">
                ${avatarHtml}
                <div>
                    <h6 class="mb-0">${username}</h6>
                    <small class="text-muted">æœ€åæ¶ˆæ¯æ—¶é—´</small>
                </div>
            </div>
        </div>
        `;
        });

        // æ›´æ–°DOM
        $('#contactsList').html(html);

        // ç»‘å®šè”ç³»äººç‚¹å‡»äº‹ä»¶
        $('.contact-item').click(function() {
            const contact = $(this).data('contact');
            selectContact(contact);
        });
    }
    /**
     * è·å–ç”¨æˆ·åçš„é¦–å­—æ¯æˆ–é¦–å­—ç¬¦
     * @param {string} name ç”¨æˆ·å
     * @returns {string} é¦–å­—æ¯æˆ–é¦–å­—ç¬¦
     */
    function getInitials(name) {
        if (!name || name.length === 0) return '';
        // å¦‚æœæ˜¯ä¸­æ–‡ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå­—ç¬¦
        if (/[\u4e00-\u9fa5]/.test(name[0])) {
            return name[0];
        }
        // å¦åˆ™è¿”å›é¦–å­—æ¯å¤§å†™
        return name.charAt(0).toUpperCase();
    }
    // é€‰æ‹©è”ç³»äºº
    function selectContact(contact) {
        currentContact = contact;
        $('.contact-item').removeClass('active');
        $(`.contact-item[data-contact="${contact}"]`).addClass('active');

        $('#currentContact').text(contact);
        $('#messageInput').prop('disabled', false);
        $('#sendButton').prop('disabled', false);

        // åŠ è½½å†å²æ¶ˆæ¯
        sendAjaxRequest({
            uid: uid,
            operateSymbol: 3,
            sendName: null,
            receiveName: currentContact,
            message: null,
            time: null
        }, function(response) {
            if (response && response.length > 0) {
                displayMessages(response);
            } else {
                $('#chatMessages').html(`
                        <div class="d-flex justify-content-center align-items-center h-100">
                            <div class="text-center text-muted">
                                <i class="bi bi-chat-left-text" style="font-size: 48px;"></i>
                                <h4 class="mt-3">å¼€å§‹ä¸ ${contact} èŠå¤©</h4>
                            </div>
                        </div>
                    `);
            }
        });

        // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šè‡ªåŠ¨éšè—ä¸­é—´æ 
        if (window.innerWidth <= 768) {
            $('#middlebar').addClass('collapsed');
        }
    }

    // å‘é€æ¶ˆæ¯
    function sendMessage() {
        const messageText = $('#messageInput').val().trim();
        if (!messageText) return;

        const now = new Date();
        const timestamp = now.toISOString();

        sendAjaxRequest({
            uid: uid,
            operateSymbol: 2,
            sendName: uid, // å‡è®¾uidä¹Ÿæ˜¯å‘é€è€…åç§°
            receiveName: currentContact,
            message: messageText,
            time: timestamp
        }, function(response) {
            if (response && response.success) {
                $('#messageInput').val('');
                // ç«‹å³æ˜¾ç¤ºå‘é€çš„æ¶ˆæ¯
                displayMessage({
                    sendName: uid,
                    receiveName: currentContact,
                    message: messageText,
                    time: timestamp
                }, true);
            }
        });
    }

    // æ˜¾ç¤ºå•æ¡æ¶ˆæ¯
    function displayMessage(message, isSent) {
        const messageTime = new Date(message.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        const messageElement = `
                <div class="message ${isSent ? 'sent' : 'received'}">
                    <div>${message.message}</div>
                    <div class="message-time">${messageTime}</div>
                </div>
            `;

        $('#chatMessages').append(messageElement);
        scrollToBottom();
    }

    // æ˜¾ç¤ºå¤šæ¡æ¶ˆæ¯
    function displayMessages(messages) {
        let html = '';

        messages.forEach(message => {
            const isSent = message.sendName == uid;
            const messageTime = new Date(message.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            html += `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        <div>${message.message}</div>
                        <div class="message-time">${messageTime}</div>
                    </div>
                `;
        });

        $('#chatMessages').html(html);
        scrollToBottom();
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
</script>
</body>
</html>
<!--<!DOCTYPE html>-->
<!--<html xmlns:th="http://www.thymeleaf.org">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>Chat Application</title>-->
<!--    <style>-->
<!--        /* åŸºç¡€æ ·å¼ - å‚è€ƒDeepSeeké…è‰²æ–¹æ¡ˆ */-->
<!--        :root {-->
<!--            &#45;&#45;bg-color: #f5f5f5;-->
<!--            &#45;&#45;sidebar-bg: #2d2d2d;-->
<!--            &#45;&#45;active-color: #4a90e2;-->
<!--            &#45;&#45;text-color: #333;-->
<!--            &#45;&#45;border-color: #e0e0e0;-->
<!--        }-->

<!--        /* å“åº”å¼å¸ƒå±€ */-->
<!--        body {-->
<!--            margin: 0;-->
<!--            padding: 0;-->
<!--            font-family: 'Segoe UI', sans-serif;-->
<!--            display: flex;-->
<!--            height: 100vh;-->
<!--            background: var(&#45;&#45;bg-color);-->
<!--        }-->

<!--        /* å·¦ä¾§åŠŸèƒ½æ  */-->
<!--        .sidebar {-->
<!--            width: 60px;-->
<!--            background: var(&#45;&#45;sidebar-bg);-->
<!--            display: flex;-->
<!--            flex-direction: column;-->
<!--            align-items: center;-->
<!--            padding: 20px 0;-->
<!--            gap: 20px;-->
<!--        }-->

<!--        /* ä¸­é—´æ ï¼ˆè”ç³»äºº/æœç´¢ï¼‰ */-->
<!--        .middle-bar {-->
<!--            width: 260px;-->
<!--            background: white;-->
<!--            border-right: 1px solid var(&#45;&#45;border-color);-->
<!--            transition: transform 0.3s;-->
<!--        }-->

<!--        /* å³ä¾§èŠå¤©åŒº */-->
<!--        .chat-area {-->
<!--            flex: 1;-->
<!--            display: flex;-->
<!--            flex-direction: column;-->
<!--            background: white;-->
<!--        }-->

<!--        /* ç§»åŠ¨ç«¯é€‚é… */-->
<!--        @media (max-width: 768px) {-->
<!--            .middle-bar {-->
<!--                position: absolute;-->
<!--                left: 60px;-->
<!--                height: 100%;-->
<!--                z-index: 100;-->
<!--            }-->
<!--            .middle-bar.collapsed {-->
<!--                transform: translateX(-100%);-->
<!--            }-->
<!--        }-->

<!--        /* å…¬å…±ç»„ä»¶æ ·å¼ */-->
<!--        .button {-->
<!--            padding: 10px;-->
<!--            border: none;-->
<!--            background: none;-->
<!--            cursor: pointer;-->
<!--            color: white;-->
<!--            border-radius: 8px;-->
<!--            transition: background 0.2s;-->
<!--        }-->

<!--        .button:hover {-->
<!--            background: rgba(255,255,255,0.1);-->
<!--        }-->

<!--        .chat-message {-->
<!--            max-width: 70%;-->
<!--            padding: 12px;-->
<!--            margin: 8px;-->
<!--            border-radius: 12px;-->
<!--            word-break: break-word;-->
<!--        }-->

<!--        /* æ¶ˆæ¯è¾“å…¥åŒº */-->
<!--        .message-input {-->
<!--            display: flex;-->
<!--            padding: 20px;-->
<!--            border-top: 1px solid var(&#45;&#45;border-color);-->
<!--            background: white;-->
<!--        }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->
<!--&lt;!&ndash; å·¦ä¾§åŠŸèƒ½æ  &ndash;&gt;-->
<!--<div class="sidebar">-->
<!--    <button class="button" onclick="toggleMiddleBar()">â‰¡</button>-->
<!--    <button class="button" onclick="showContacts()">ğŸ‘¥</button>-->
<!--    <button class="button" onclick="showSearch()">ğŸ”</button>-->
<!--</div>-->

<!--&lt;!&ndash; ä¸­é—´æ  &ndash;&gt;-->
<!--<div class="middle-bar" id="middleBar">-->
<!--    &lt;!&ndash; è”ç³»äººåˆ—è¡¨ &ndash;&gt;-->
<!--    <div id="contactsList" class="p-2">-->
<!--        <h3 class="p-2">Contacts</h3>-->
<!--        <div id="contactsContainer"></div>-->
<!--    </div>-->

<!--    &lt;!&ndash; æœç´¢åŒº &ndash;&gt;-->
<!--    <div id="searchSection" style="display: none;">-->
<!--        <div class="p-2">-->
<!--            <input type="text" id="searchInput" placeholder="Search...">-->
<!--            <button onclick="searchContacts()">Search</button>-->
<!--        </div>-->
<!--        <div id="searchResults"></div>-->
<!--    </div>-->
<!--</div>-->

<!--&lt;!&ndash; å³ä¾§èŠå¤©åŒº &ndash;&gt;-->
<!--<div class="chat-area">-->
<!--    <div id="chatHeader" class="p-2 border-bottom">Select a contact</div>-->
<!--    <div id="chatMessages" class="flex-1 overflow-auto"></div>-->
<!--    <div class="message-input">-->
<!--        <input type="text" id="messageInput" style="flex:1" placeholder="Type a message...">-->
<!--        <button onclick="sendMessage()">Send</button>-->
<!--    </div>-->
<!--</div>-->

<!--<script>-->
<!--    // å…¨å±€çŠ¶æ€ç®¡ç†-->
<!--    let currentUid = new URLSearchParams(window.location.search).get('uid');-->
<!--    let currentContact = null;-->
<!--    let contacts = {}; // {name: avatar}-->
<!--    let chatHistory = {};-->

<!--    // åˆå§‹åŒ–-->
<!--    document.addEventListener('DOMContentLoaded', () => {-->
<!--        getContacts(); // åˆå§‹åŒ–è”ç³»äºº-->
<!--        startHeartbeat(); // å¯åŠ¨å¿ƒè·³-->
<!--        startMessagePolling(); // å¯åŠ¨æ¶ˆæ¯è½®è¯¢-->
<!--    });-->

<!--    // é€šä¿¡æ–¹æ³•å°è£…-->
<!--    function sendRequest(operateSymbol, data = {}) {-->
<!--        return fetch('/api/chat', {-->
<!--            method: 'POST',-->
<!--            headers: {'Content-Type': 'application/json'},-->
<!--            body: JSON.stringify({-->
<!--                uid: currentUid,-->
<!--                operateSymbol: operateSymbol,-->
<!--                ...data-->
<!--            })-->
<!--        }).then(res => res.json());-->
<!--    }-->

<!--    // æ“ä½œå¤„ç†å‡½æ•°-->
<!--    async function getContacts() {-->
<!--        const response = await sendRequest(4);-->
<!--        if (response) {-->
<!--            contacts = response;-->
<!--            renderContacts();-->
<!--        }-->
<!--    }-->

<!--    // ç•Œé¢æ“ä½œå‡½æ•°-->
<!--    function toggleMiddleBar() {-->
<!--        document.getElementById('middleBar').classList.toggle('collapsed');-->
<!--    }-->

<!--    function showContacts() {-->
<!--        document.getElementById('searchSection').style.display = 'none';-->
<!--        document.getElementById('contactsList').style.display = 'block';-->
<!--    }-->

<!--    function showSearch() {-->
<!--        document.getElementById('contactsList').style.display = 'none';-->
<!--        document.getElementById('searchSection').style.display = 'block';-->
<!--    }-->

<!--    // å®šæ—¶ä»»åŠ¡-->
<!--    function startHeartbeat() {-->
<!--        setInterval(() => {-->
<!--            sendRequest(0, {sendName: currentUid});-->
<!--        }, 5000);-->
<!--    }-->

<!--    function startMessagePolling() {-->
<!--        setInterval(async () => {-->
<!--            if (!currentContact) return;-->
<!--            const messages = await sendRequest(1);-->
<!--            if (messages.length > 0) {-->
<!--                appendMessages(messages);-->
<!--            }-->
<!--        }, 2000);-->
<!--    }-->

<!--    // æ¶ˆæ¯å¤„ç†-->
<!--    async function sendMessage() {-->
<!--        const input = document.getElementById('messageInput');-->
<!--        const message = input.value.trim();-->
<!--        if (!message) return;-->

<!--        await sendRequest(2, {-->
<!--            receiveName: currentContact,-->
<!--            message: message,-->
<!--            time: new Date().toISOString()-->
<!--        });-->
<!--        input.value = '';-->
<!--    }-->

<!--    // æ¸²æŸ“å‡½æ•°-->
<!--    function renderContacts() {-->
<!--        const container = document.getElementById('contactsContainer');-->
<!--        container.innerHTML = Object.entries(contacts)-->
<!--            .map(([name, avatar]) => `-->
<!--                    <div class="contact-item" onclick="selectContact('${name}')">-->
<!--                        <img src="${avatar}" width="40" height="40">-->
<!--                        <span>${name}</span>-->
<!--                    </div>-->
<!--                `).join('');-->
<!--    }-->

<!--    function appendMessages(messages) {-->
<!--        const container = document.getElementById('chatMessages');-->
<!--        messages.forEach(msg => {-->
<!--            const isSelf = msg.sendName === currentUid;-->
<!--            const msgElement = document.createElement('div');-->
<!--            msgElement.className = `chat-message ${isSelf ? 'self-message' : 'other-message'}`;-->
<!--            msgElement.innerHTML = `-->
<!--                    <div class="message-content">${msg.message}</div>-->
<!--                    <div class="message-time">${new Date(msg.time).toLocaleTimeString()}</div>-->
<!--                `;-->
<!--            container.appendChild(msgElement);-->
<!--        });-->
<!--        container.scrollTop = container.scrollHeight;-->
<!--    }-->

<!--    // å…¶ä»–äº¤äº’å‡½æ•°-->
<!--    function selectContact(name) {-->
<!--        currentContact = name;-->
<!--        document.getElementById('chatHeader').textContent = name;-->
<!--        loadChatHistory();-->
<!--    }-->

<!--    async function loadChatHistory() {-->
<!--        const history = await sendRequest(3, {-->
<!--            receiveName: currentContact,-->
<!--            time: new Date().toISOString()-->
<!--        });-->
<!--        chatHistory[currentContact] = history;-->
<!--        renderChatHistory();-->
<!--    }-->
<!--</script>-->
<!--</body>-->
<!--</html>-->
